<form id="edit-job-form"
hx-put="{{ url_for('job.update_job', job_id=job.id) }}"
hx-include="#edit-job-form"
hx-on--after-request="if(!event.detail.successful) { 
    document.getElementById('errors-container').outerHTML = event.detail.xhr.response; 
} else { 
    document.getElementById('job-modal').style.display='none'; }"
{% if view_type == 'team' %}
hx-target="#team-timetable-view"
hx-swap="innerHTML"
{% else %}
hx-target="#job-list"
hx-swap="outerHTML"
{% endif %}

>
    <input type="hidden" name="view_type" value="{{ view_type }}">
    <h2>Edit Job</h2>
    {% include '_form_response.html' %}
    <div class="job-update-compact">
        <!-- Group 1: Time, Duration & Description (TOP) -->
        <div class="form-group">
            <div class="form-card time-card">
                <div class="card-header">
                    <span class="card-icon"><img src="{{ url_for('static', filename='icons/clock.svg') }}" alt="Time" class="icon"></span>
                    <span class="card-title">Date & Time</span>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="time">Start Time</label>
                        <input type="time" id="time" name="time" value="{{ job.time.strftime(DATETIME_FORMATS['TIME_FORMAT']) }}" required pattern="^([01]\d|2[0-3]):[0-5]\d$" title="Please enter start time in 24-hour format (HH:mm)">
                    </div>
                    <div class="form-field">
                        <label for="end_time">End Time</label>
                        <input type="time" id="end_time" name="end_time" value="{{ job.end_time.strftime(DATETIME_FORMATS['TIME_FORMAT']) }}" required pattern="^([01]\d|2[0-3]):[0-5]\d$" title="Please enter end time in 24-hour format (HH:mm)">
                    </div>
                    <div class="form-field">
                        <label for="date">Date</label>
                        <input type="date-local" id="date" name="date" value="{{ job.date.strftime(DATETIME_FORMATS['DATE_FORMAT']) }}" placeholder="Select Date">
                    </div>
                </div>
            </div>
            <div class="form-card description-card">
                <div class="card-header">
                    <span class="card-icon"><img src="{{ url_for('static', filename='icons/notes.svg') }}" alt="Description" class="icon"></span>
                    <span class="card-title">Description</span>
                </div>
                <div class="form-field">
                    <textarea id="description" name="notes" rows="3" placeholder="Job description">{{ job.description }}</textarea>
                </div>
            </div>
        </div>
    
        <!-- Group 2: Property, Tenant & Access Details -->
        <div class="form-group">
            <div class="form-card address-card">
                <div class="card-header">
                    <span class="card-icon"><img src="{{ url_for('static', filename='icons/location-pin.svg') }}" alt="Location Pin" class="icon"></span>
                    <span class="card-title">Property</span>
                </div>
                <div class="form-field">
                    <select id="property_id" name="property_id" required>
                        {% for property in properties %}
                            <option value="{{ property.id }}" {% if job.property.id == property.id %}selected{% endif %}>{{ property.address }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-card tenant-card">
                <div class="card-header">
                    <span class="card-icon"><img src="{{ url_for('static', filename='icons/user.png') }}" alt="User Profile" class="icon user-icon"></span>
                    <span class="card-title">Tenant</span>
                </div>
                <div class="form-field">
                    <label for="arrival_datetime">Tenant Arrival Date & Time</label>
                    <input type="text" id="arrival_datetime" name="arrival_datetime" value="{{ job.arrival_datetime.strftime(DATETIME_FORMATS['DATETIME_FORMAT']) if job.arrival_datetime else '' }}" placeholder="Select Date and Time" class="flatpickr">
                </div>
            </div>
            {% if job.property.access_notes %}
            <div class="form-card access-card">
                <div class="card-header">
                    <span class="card-icon"><img src="{{ url_for('static', filename='icons/key.svg') }}" alt="Access Key" class="icon"></span>
                    <span class="card-title">Access</span>
                </div>
                <div class="form-field">
                    <textarea rows="2" id="access_notes" name="access_notes">{{ job.property.access_notes }}</textarea>
                </div>
            </div>
            {% endif %}
        </div>
    
        <!-- Group 3: Teams & Cleaners -->
        <div class="form-group">
            <div class="form-card teams-card">
                <div class="card-header">
                    <span class="card-icon"><img src="{{ url_for('static', filename='icons/team.svg') }}" alt="Teams" class="icon"></span>
                    <span class="card-title">Teams</span>
                </div>
                <div class="form-field">
                    <select id="assigned_teams" name="assigned_teams" multiple>
                        {% for team in teams %}
                            <option value="{{ team.id }}" {% if team in job_teams %}selected{% endif %}>{{ team.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-card cleaners-card">
                <div class="card-header">
                    <span class="card-icon"><img src="{{ url_for('static', filename='icons/broom.svg') }}" alt="Cleaners" class="icon"></span>
                    <span class="card-title">Cleaners</span>
                </div>
                <div class="form-field">
                    <select id="assigned_cleaners" name="assigned_cleaners" multiple>
                        {% for user in users %}
                            <option value="{{ user.id }}" {% if user in job_cleaners %}selected{% endif %}>{{ user.first_name }} {{ user.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    
        <div class="form-actions">
            <button type="submit" class="button save-button">
                <img src="{{ url_for('static', filename='icons/save.svg') }}" alt="Save" class="save-icon icon"> Save Changes
            </button>
        </div>
    </div>
</form>
