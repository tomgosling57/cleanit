<form id="job-report-form" 
      hx-post="{{ url_for('job.submit_job_report', job_id=job.id) }}"
      hx-target="#job-modal-content"
      hx-swap="innerHTML"
      hx-on--after-request="if(event.detail.successful) { handleReportSubmitted({{ job.id }}); }">
   <h2>Complete Job Report</h2>
   <p class="modal-subtitle">Job #{{ job.id }} - {{ job.property.address }}</p>
   
   {% include '_form_response.html' %}
   <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
   <input type="hidden" name="view_type" value="{{ view_type }}">
   <input type="hidden" name="is_complete" value="True">
   
   <div class="job-report-compact">
        <!-- Step 1: Report Text Entry -->
        <div class="form-group">
            <div class="form-card report-card">
                <div class="card-header">
                    <span class="card-icon"><img src="{{ url_for('static', filename='icons/clipboard.svg') }}" alt="Report" class="icon"></span>
                    <span class="card-title">Job Report</span>
                </div>
                <div class="form-field">
                    <label for="report">Report Details <span class="required">*</span></label>
                    <textarea id="report" name="report" rows="6" placeholder="Enter detailed report of the completed job. Include any issues, observations, or notes for future reference." required>{{ job.report if job.report else '' }}</textarea>
                    <div class="field-help">Required field. Describe the work completed, any issues encountered, and recommendations.</div>
                </div>
            </div>
            
            <!-- Existing Report Preview (if re-marking as complete) -->
            {% if job.report %}
            <div class="form-card existing-report-card">
                <div class="card-header">
                    <span class="card-icon"><img src="{{ url_for('static', filename='icons/notes.svg') }}" alt="Existing Report" class="icon"></span>
                    <span class="card-title">Existing Report</span>
                </div>
                <div class="existing-report-preview">
                    <p><strong>Current report:</strong> {{ job.report[:100] }}{% if job.report|length > 100 %}...{% endif %}</p>
                    <p class="small-note">You can modify the report above. Existing media will be preserved.</p>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Navigation Instructions -->
        <div class="form-card instructions-card">
            <div class="card-header">
                <span class="card-icon"><img src="{{ url_for('static', filename='icons/arrow-right.svg') }}" alt="Instructions" class="icon"></span>
                <span class="card-title">Next Steps</span>
            </div>
            <div class="instructions-content">
                <ol>
                    <li><strong>Enter report details</strong> in the text area above (required)</li>
                    <li><strong>Click "Next: Add Media"</strong> to proceed to media gallery</li>
                    <li><strong>Upload photos/videos</strong> of the completed job (optional)</li>
                    <li><strong>Click "Submit"</strong> to finalize job completion</li>
                </ol>
            </div>
        </div>
   </div>
   
   <div class="form-actions">
        <button type="submit" class="button save-button">
            <img src="{{ url_for('static', filename='icons/arrow-right.svg') }}" alt="Next" class="icon"> Next: Add Media
        </button>
        <button type="button" class="button cancel-button" onclick="document.getElementById('job-modal').style.display='none'">
            Cancel
        </button>
        {% if job.is_complete and job.report %}
        <button type="button" class="button secondary-button" 
                onclick="skipToGallery({{ job.id }})"
                style="margin-left: auto;">
            Skip to Gallery
        </button>
        {% endif %}
   </div>
</form>

<script>
function handleReportSubmitted(jobId) {
    // After report is submitted, load the gallery modal
    loadJobGallery(jobId);
}

function loadJobGallery(jobId) {
    // Open the enhanced gallery for this job
    ENHANCED_GALLERY.open({type: 'job', id: jobId});
    
    // Close the current modal
    document.getElementById('job-modal').style.display = 'none';
}

function skipToGallery(jobId) {
    // Skip report entry and go directly to gallery
    loadJobGallery(jobId);
}
</script>