<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Cleaning Timetable{% endblock %}</title>
    
    
    {% include 'styles.html' %}
    
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <script>
        // Global variables for timezone handling
        window.APP_TIMEZONE = "{{ APP_TIMEZONE }}";
        window.APP_NOW_ISO = "{{ APP_NOW_ISO }}";
        window.DATETIME_FORMATS = "{{ DATETIME_FORMATS|tojson|safe }}";
    </script>
</head>
<body data-csrf-token="{{ csrf_token() }}" data-app-timezone="{{ APP_TIMEZONE }}" hx-headers='{"X-CSRFToken": "{{ csrf_token() }}"}'>
    <!-- Script must remain in body -->
    <script src="https://cdn.jsdelivr.net/npm/dragula@3.7.3/dist/dragula.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        document.body.addEventListener('htmx:afterSwap', (event) => {
            // Re-init flatpickr on updated content
            flatpickr(".flatpickr", {
                enableTime: true,
                dateFormat: "{{DATETIME_FORMATS['DATETIME_FORMAT_FLATPICKR']}}", // this should be iso format but it would require a controller update as well
                altInput: true,
                altFormat: "{{DATETIME_FORMATS['DATETIME_FORMAT_JOBS_JS']}}",
                allowInput: true,
                onOpen: function(selectedDates, dateStr, instance) {
                    // Ensure the calendar opens correctly for existing values
                    if (instance.input.value) {
                        instance.setDate(instance.input.value, false);
                    }
                }
            });
            
            // Check for drag and drop containers and reinitialize if needed
            const target = event.detail.target;
            
            // Check for team member drag and drop containers
            if (target.querySelector('.members-list') || target.closest('.teams-grid') || target.classList.contains('team-card')) {
                console.log('Base template: Detected team member drag and drop containers after HTMX swap.');
                // Try to call global init function if it exists
                if (window.initTeamMemberDragula) {
                    window.initTeamMemberDragula();
                }
            }
            
            // Check for job card drag and drop containers
            if (target.querySelector('.team-column') || target.closest('#team-columns-container') || target.id === 'team-timetable-view') {
                console.log('Base template: Detected job card drag and drop containers after HTMX swap.');
                // Try to call global init function if it exists
                if (window.initJobCardDragula) {
                    window.initJobCardDragula();
                }
            }
        });

    </script>
    <header>
        <nav>
            <a href="{{ url_for('job.timetable') }}">My Jobs</a>
            {% if current_user.is_authenticated and current_user.role == 'admin' %}
            <a href="{{ url_for('teams.teams') }}">Teams</a>
            <a href="{{ url_for('user.users_view') }}">Users</a>
            <a href="{{ url_for('properties.properties_collection') }}">Address Book</a>
            {% endif %}
            <a href="{{ url_for('user.get_user_profile')}}">My Profile</a>
            <a href="{{ url_for('user.login') }}">Login</a>
        </nav>
    </header>
    <main>
        {% block content %}{% endblock %}
    </main>
    
    <!-- Include gallery modal -->
    {% include 'components/media_gallery_modal.html' %}
    
    <!-- Alert Manager -->
    <script src="/static/js/alerts.js"></script>
    
    <!-- Gallery JavaScript -->
    <script src="/static/js/gallery-core.js"></script>
    <script src="/static/js/gallery-dom-events.js"></script>
    <script src="/static/js/gallery.js"></script>
    <script src="/static/js/gallery-enhanced.js"></script>
    

    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script>
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            event.preventDefault();

            const modals = Array.from(document.getElementsByClassName('modal'))
                .filter(m => getComputedStyle(m).display !== 'none');

            if (modals.length === 0) return;

            let topModal = modals[0];
            let topZ = parseInt(getComputedStyle(topModal).zIndex) || 0;

            for (const modal of modals) {
                const z = parseInt(getComputedStyle(modal).zIndex) || 0;
                
                // Skip modals that contain a job gallery
                if (modal.getElementsByClassName('job-gallery-wrapper').length > 0) {
                    console.log('Cannot close modal on Escape key ' + modal.id);
                    return;
                }

                if (z > topZ) {
                    topZ = z;
                    topModal = modal;
                }
            }

            topModal.style.display = 'none';
            console.log('Closed modal on Escape key ' + topModal.id);
        }
    });
    </script>

</body>
</html>
