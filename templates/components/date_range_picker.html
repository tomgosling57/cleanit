<!-- Date Range Picker Component for Property Job Filtering -->
<div class="date-filter-container" id="date-filter-container">
    <form class="date-filter-form"
          hx-get="/address-book/property/{{ property_id }}/jobs/filtered"
          hx-target="#job-list"
          hx-swap="outerHTML"
          hx-indicator="#filter-indicator-{{ property_id }}">
        
        <div class="filter-row">
            <div class="filter-group">
                <label for="start-date">From:</label>
                <div class="date-picker-wrapper" data-property-id="{{ property_id }}" data-date-type="start" style="position: relative; display: block; width: 100%;">
                    <!-- Visible text input - always functional -->
                    <input type="text" 
                        id="start-date-display" 
                        name="start_date_display"
                        value="{{ display_start_date }}"
                        placeholder="dd-mm-yyyy"
                        class="date-input date-display-input"
                        oninput="syncDisplayToHidden('start')"
                        onblur="validateAndSyncDate('start')"
                        style="width: 100%;">
                    
                    <!-- Hidden date picker - only used when JS is enabled -->
                    <input type="date" 
                        id="start-date" 
                        name="start_date" 
                        value="{{ default_start_date }}"
                        class="date-picker-input"
                        style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; z-index: -1; pointer-events: none;"
                        onchange="updateDisplayDate('start')">
                </div>
            </div>

            <div class="filter-group">
                <label for="end-date">To:</label>
                <div class="date-picker-wrapper" data-property-id="{{ property_id }}" data-date-type="end" style="position: relative; display: block; width: 100%;">
                    <!-- Visible text input - always functional -->
                    <input type="text" 
                        id="end-date-display" 
                        name="end_date_display"
                        value="{{ display_end_date }}"
                        placeholder="dd-mm-yyyy"
                        class="date-input date-display-input"
                        oninput="syncDisplayToHidden('end')"
                        onblur="validateAndSyncDate('end')"
                        style="width: 100%;">
                    
                    <!-- Hidden date picker - only used when JS is enabled -->
                    <input type="date" 
                        id="end-date" 
                        name="end_date" 
                        value="{{ default_end_date }}"
                        class="date-picker-input"
                        style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; z-index: -1; pointer-events: none;"
                        onchange="updateDisplayDate('end')">
                </div>
            </div>
                
            <div class="filter-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" 
                           id="show-past"
                           value="true"
                           {% if not show_past %}checked{% endif %}
                           class="checkbox-input">
                    Hide Past Jobs
                </label>
            </div>
            
            <div class="filter-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" 
                            id="show-completed"
                           name="show_completed" 
                           value="true"
                           {% if show_completed %}checked{% endif %}
                           class="checkbox-input">
                    Show Completed
                </label>
            </div>
        </div>
        
        <div class="filter-actions">
            <button type="submit" class="btn btn-primary btn-sm">
                <span class="btn-text">Apply Filters</span>
                <span class="spinner-border spinner-border-sm htmx-indicator" 
                      id="filter-indicator"
                      role="status" 
                      aria-hidden="true"></span>
            </button>
            
            <button type="button"
                    class="btn btn-secondary btn-sm"
                    onclick="resetDateFilters()">
                Reset
            </button>
        </div>
    </form>
    
    <div class="filter-info" id="filter-info" {% if filter_applied %}style="display:block;"{% else %}style="display:none;"{% endif %}>
        {% if filter_applied %}
        <small class="text-muted">
            Showing jobs from {{ display_start_date }} to {{ display_end_date }}
            {% if not show_past %}(past jobs hidden){% endif %}
            {% if not show_completed %}(completed hidden){% endif %}
        </small>
        {% endif %}
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // Enable JS-enhanced features
    function enhanceDatePickers() {
        const containers = document.querySelectorAll('[id^="date-filter-container-"]');
        
        containers.forEach(container => {
            const propertyId = container.id.replace('date-filter-container-', '');
            
            // Make date picker inputs interactive
            const startDatePicker = document.getElementById('start-date');
            const endDatePicker = document.getElementById('end-date');
            const startDisplay = document.getElementById('start-date-display');
            const endDisplay = document.getElementById('end-date-display');
            
            if (startDatePicker && startDisplay) {
                startDatePicker.style.zIndex = '2';
                startDatePicker.style.pointerEvents = 'auto';
                startDisplay.style.pointerEvents = 'none';
                startDisplay.setAttribute('tabindex', '-1');
            }
            
            if (endDatePicker && endDisplay) {
                endDatePicker.style.zIndex = '2';
                endDatePicker.style.pointerEvents = 'auto';
                endDisplay.style.pointerEvents = 'none';
                endDisplay.setAttribute('tabindex', '-1');
            }
            
            // Initialize display dates
            updateDisplayDate('start');
            updateDisplayDate('end');
        });
        
        // Add click handlers to wrappers using event delegation
        const wrappers = document.querySelectorAll('.date-picker-wrapper');
        wrappers.forEach(wrapper => {
            wrapper.style.cursor = 'pointer';
            
            wrapper.addEventListener('click', function(e) {
                const propertyId = this.dataset.propertyId;
                const dateType = this.dataset.dateType;
                const datePicker = document.getElementById(dateType + '-date');
                
                if (datePicker) {
                    try {
                        datePicker.showPicker();
                    } catch (err) {
                        // Silently fail if showPicker is not supported or blocked
                        console.debug('showPicker not available:', err);
                    }
                }
            });
        });
    }
    
    function resetDateFilters() {
        const today = new Date().toISOString().split('T')[0];
        
        const futureDate = new Date();
        futureDate.setDate(futureDate.getDate() + 30);
        const futureDateStr = futureDate.toISOString().split('T')[0];
        
        // Reset hidden inputs
        document.getElementById('start-date').value = today;
        document.getElementById('end-date').value = futureDateStr;
        
        // Update display inputs
        updateDisplayDate('start');
        updateDisplayDate('end');
        
        // Reset checkboxes
        document.querySelector('#date-filter-container input[name="show_past"]').checked = true;
        document.querySelector('#date-filter-container input[name="show_completed"]').checked = true;
        
        // Submit the form
        document.querySelector('#date-filter-container form').dispatchEvent(new Event('submit'));
    }
    
    function updateDisplayDate(dateType) {
        const hiddenInput = document.getElementById(dateType + '-date');
        const displayInput = document.getElementById(dateType + '-date-display');
        
        if (hiddenInput.value) {
            const [year, month, day] = hiddenInput.value.split('-');
            displayInput.value = `${day}-${month}-${year}`;
        }
    }
    
    function syncDisplayToHidden(dateType) {
        const displayInput = document.getElementById(dateType + '-date-display');
        
        // Mark that user is actively typing
        displayInput.dataset.typing = 'true';
        
        // Remove non-numeric and non-dash characters
        let value = displayInput.value.replace(/[^\d-]/g, '');
        
        // Auto-format as user types: dd-mm-yyyy
        if (value.length >= 2 && value.charAt(2) !== '-') {
            value = value.slice(0, 2) + '-' + value.slice(2);
        }
        if (value.length >= 5 && value.charAt(5) !== '-') {
            value = value.slice(0, 5) + '-' + value.slice(5);
        }
        
        displayInput.value = value.slice(0, 10); // Limit to dd-mm-yyyy length
    }
    
    function validateAndSyncDate(dateType) {
        const displayInput = document.getElementById(dateType + '-date-display');
        const hiddenInput = document.getElementById(dateType + '-date');
        
        // Clear typing flag
        displayInput.dataset.typing = '';
        
        const value = displayInput.value;
        const regex = /^(\d{2})-(\d{2})-(\d{4})$/;
        const match = value.match(regex);
        
        if (match) {
            const [, day, month, year] = match;
            
            // Validate the date
            const date = new Date(year, month - 1, day);
            if (date.getFullYear() == year && 
                date.getMonth() == month - 1 && 
                date.getDate() == day) {
                
                // Convert to ISO format for hidden input
                hiddenInput.value = `${year}-${month}-${day}`;
                displayInput.classList.remove('is-invalid');
            } else {
                // Invalid date
                displayInput.classList.add('is-invalid');
                hiddenInput.value = '';
            }
        } else if (value === '') {
            // Empty is valid
            hiddenInput.value = '';
            displayInput.classList.remove('is-invalid');
        } else {
            // Invalid format
            displayInput.classList.add('is-invalid');
            hiddenInput.value = '';
        }
    }
    
    // Make functions globally accessible
    window.resetDateFilters = resetDateFilters;
    window.updateDisplayDate = updateDisplayDate;
    window.syncDisplayToHidden = syncDisplayToHidden;
    window.validateAndSyncDate = validateAndSyncDate;
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', enhanceDatePickers);
    } else {
        enhanceDatePickers();
    }
})();
</script>