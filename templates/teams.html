{% extends "base.html" %}

{% block title %}Teams Management{% endblock %}

{% block content %}
    <div class="container">
        <div class="header-with-button">
            <h1>Teams Management</h1>
        </div>

        <div class="teams-container">
            {% if teams %}
                <div class="teams-grid">
                    {% for team in teams %}
                        {% include 'team_card.html' %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-teams-message">
                    <p>No teams found. Create your first team to get started.</p>
                </div>
            {% endif %}
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js"></script> {# Make sure to use the correct version #}
    <script>
        function initDragula() {
            // If there's an existing instance, clean it up
            if (window.drake) {
                try {
                    window.drake.destroy();
                } catch (e) {
                    // Dragula’s destroy() isn’t always defined on all builds, so be safe
                    console.warn('Could not destroy existing Dragula instance:', e);
                }
            }

            const teamContainers = Array.from(document.querySelectorAll('.members-list'));
            if (teamContainers.length === 0) return;

            const drake = dragula(teamContainers);

            drake.on('drop', handleDrop);

            window.drake = drake; // keep global ref
            console.log('Dragula initialised for', teamContainers.length, 'containers');
        }

        function handleDrop(el, target, source) {
            const memberId = el.dataset.memberId;
            const newTeamId = target.closest('.team-card').id;
            const newTeamIdNumber = newTeamId.split('-').pop();
            const oldTeamId = source.closest('.team-card').id;
            const oldTeamIdNumber = oldTeamId.split('-').pop();
            const apiUrl = "{{ url_for('teams.add_team_member', team_id=0) }}".replace("0", newTeamIdNumber);

            fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: memberId,
                    old_team_id: oldTeamIdNumber
                })
            })
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    alert('Error: ' + (data.error || 'Unknown error'));
                    return;
                }
                htmx.find('#' + oldTeamId).outerHTML = data.oldTeam;
                htmx.find('#' + newTeamId).outerHTML = data.newTeam;

                // reinit for the updated DOM
                initDragula();
            })
            .catch(console.error);
        }

        document.addEventListener('DOMContentLoaded', initDragula);

    </script>
{% endblock %}