{% extends "base.html" %}

{% block title %}Teams Management{% endblock %}

{% block content %}
    <div class="container">
        <div class="header-with-button">
            <h1>Teams Management</h1>
            <button id="open-create-team-modal" class="button"
                    hx-get="/teams/create_form"
                    hx-target="#team-modal-content"
                    hx-swap="innerHTML"
                    hx-on--after-request="document.getElementById('team-modal').style.display='flex'">
                <span class="icon">{{ svg_icons['plus-solid-full'] | safe }}</span>
                <span class="button-text">Create Team</span>
            </button>
        </div>

        <div class="teams-container">
            {% include '_form_response.html' %}
            {% if teams %}
                <div class="teams-grid" id="teams-list-container" data-reinit-dragula="team-members">
                    {% include 'team_list.html' %}
                </div>
                </div>
            {% else %}
                <div class="no-teams-message">
                    <p>No teams found. Create your first team to get started.</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Teams Modal -->
    {% with modal_name='team' %}
    {% include 'modal.html' %} 
    {% endwith %}

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/team_styles.css') }}">
    <script src="{{ url_for('static', filename='js/drag_and_drop.js') }}"></script>
    
    <script>
        // Ensure team member drag and drop is initialized on the teams page
        function initTeamsPageDragula() {
            console.log('Teams page: Checking for team member drag and drop containers...');
            
            // Check if global init function exists
            if (window.initTeamMemberDragula) {
                console.log('Teams page: Found initTeamMemberDragula, calling it.');
                window.initTeamMemberDragula();
                return true;
            }
            
            // Fallback: check for containers and log if found
            const hasMemberLists = document.querySelectorAll('.members-list').length > 0;
            if (hasMemberLists) {
                console.log('Teams page: Found .members-list containers but initTeamMemberDragula not available.');
                console.log('Teams page: Waiting for drag_and_drop.js module to load...');
                // Try again after a delay
                setTimeout(initTeamsPageDragula, 100);
            }
            
            return false;
        }
        
        // Function to initialize teams page
        function initTeamsPage() {
            console.log('Teams page: Initializing...');
            
            // Try to initialize dragula immediately
            initTeamsPageDragula();
            
            // Also set up a fallback initialization after a longer delay
            setTimeout(() => {
                if (!window.initTeamMemberDragula) {
                    console.log('Teams page: initTeamMemberDragula still not available after delay.');
                    // Check if drag_and_drop.js loaded but functions aren't on window
                    // Try to detect if module loaded by checking for other globals
                    if (window.drake || window.dragula) {
                        console.log('Teams page: Dragula library loaded but init function not available.');
                        // Force reinitialization by triggering custom event
                        document.dispatchEvent(new CustomEvent('teamListUpdated'));
                    }
                }
            }, 500);
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('Teams page: DOMContentLoaded fired.');
                initTeamsPage();
            });
        } else {
            // DOM already loaded (e.g., after HTMX swap)
            console.log('Teams page: DOM already loaded, initializing.');
            setTimeout(initTeamsPage, 50);
        }
        
        // Listen for HTMX swaps
        if (typeof htmx !== 'undefined') {
            htmx.on('htmx:afterSwap', function(event) {
                const target = event.detail.target;
                
                // Check if this swap affects teams
                if (target.closest('.teams-grid') ||
                    target.classList.contains('team-card') ||
                    target.querySelector('.members-list')) {
                    console.log('Teams page: HTMX swap detected in teams area.');
                    setTimeout(() => {
                        initTeamsPageDragula();
                    }, 100);
                }
            });
        }
        
        // Global function that can be called from elsewhere
        window.reinitTeamsDragula = function() {
            console.log('Teams page: Manual reinitialization requested.');
            initTeamsPageDragula();
        };
    </script>
{% endblock %}