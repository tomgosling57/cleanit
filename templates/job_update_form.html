<form id="edit-job-form"
hx-put="{{ url_for('job.update_job', job_id=job.id) }}"
hx-target="#job-details-modal-content, #job-list"
hx-swap="multi: #job-details-modal-content:innerHTML, #job-list:innerHTML"
hx-include="#edit-job-form"
>
    <h2>Edit Job</h2>
    <div class="job-update-compact">
        <!-- Group 1: Time, Duration & Description (TOP) -->
        <div class="form-group">
            <div class="form-card time-card">
                <div class="card-header">
                    <span class="card-icon">üïê</span>
                    <span class="card-title">Schedule</span>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <input type="time" id="time" name="time" value="{{ job.time.strftime('%H:%M') }}" required pattern="^([01]\d|2[0-3]):[0-5]\d$" title="Please enter time in 24-hour format (HH:mm)">
                    </div>
                    <div class="form-field">
                        <input type="number" id="duration" name="duration" value="{{ job.duration }}" min="1" max="12" required>
                    </div>
                </div>
            </div>
            <div class="form-card description-card">
                <div class="card-header">
                    <span class="card-icon">üìù</span>
                    <span class="card-title">Description</span>
                </div>
                <div class="form-field">
                    <textarea id="description" name="notes" rows="3" placeholder="Job description">{{ job.description }}</textarea>
                </div>
            </div>
        </div>
    
        <!-- Group 2: Property, Client & Access Details -->
        <div class="form-group">
            <div class="form-card address-card">
                <div class="card-header">
                    <span class="card-icon">üìç</span>
                    <span class="card-title">Property</span>
                </div>
                <div class="form-field">
                    <select id="property_id" name="property_id" required>
                        {% for property in properties %}
                            <option value="{{ property.id }}" {% if job.property.id == property.id %}selected{% endif %}>{{ property.address }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-card client-card">
                <div class="card-header">
                    <span class="card-icon">üë§</span>
                    <span class="card-title">Client</span>
                </div>
                <div class="form-field">
                    <input type="text" value="{{ job.property.client_name or 'Unknown Client' }}" readonly>
                </div>
                <div class="form-field">
                    <input type="text" value="{{ job.property.client_phone or 'No phone' }}" readonly>
                </div>
            </div>
            {% if job.property.access_notes %}
            <div class="form-card access-card">
                <div class="card-header">
                    <span class="card-icon">üîë</span>
                    <span class="card-title">Access</span>
                </div>
                <div class="form-field">
                    <textarea rows="2" readonly>{{ job.property.access_notes }}</textarea>
                </div>
            </div>
            {% endif %}
        </div>
    
        <!-- Group 3: Teams & Cleaners -->
        <div class="form-group">
            <div class="form-card teams-card">
                <div class="card-header">
                    <span class="card-icon">üë•</span>
                    <span class="card-title">Teams</span>
                </div>
                <div class="form-field assignment-field">
                    <select id="team_select" class="compact-select">
                        {% for team in teams %}
                            <option value="{{ team.id }}">{{ team.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="add-button" onclick="addAssignment('team')">‚ûï</button>
                </div>
                <div id="selected_teams" class="assignment-tags">
                    {% for team in job_teams %}
                        <span class="assignment-tag" data-id="{{ team.id }}">
                            {{ team.name }}
                            <input type="hidden" name="assigned_teams" value="{{ team.id }}">
                            <button type="button" class="remove-button" onclick="removeAssignment(this)">‚úñÔ∏è</button>
                        </span>
                    {% endfor %}
                </div>
            </div>
            <div class="form-card cleaners-card">
                <div class="card-header">
                    <span class="card-icon">üßπ</span>
                    <span class="card-title">Cleaners</span>
                </div>
                <div class="form-field assignment-field">
                    <select id="cleaner_select" class="compact-select">
                        {% for user in users %}
                            <option value="{{ user.id }}">{{ user.username }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="add-button" onclick="addAssignment('cleaner')">‚ûï</button>
                </div>
                <div id="selected_cleaners" class="assignment-tags">
                    {% for cleaner in job_cleaners %}
                        <span class="assignment-tag" data-id="{{ cleaner.id }}">
                            {{ cleaner.username }}
                            <input type="hidden" name="assigned_cleaners" value="{{ cleaner.id }}">
                            <button type="button" class="remove-button" onclick="removeAssignment(this)">‚úñÔ∏è</button>
                        </span>
                    {% endfor %}
                </div>
            </div>
        </div>
    
        <div class="form-actions">
            <button type="submit" class="button save-button">
                üíæ Save Changes
            </button>
        </div>
    </div>
</form>

<script>
    function addAssignment(type) {
        const selectElement = document.getElementById(type + '_select');
        const selectedId = selectElement.value;
        const selectedName = selectElement.options[selectElement.selectedIndex].text;
        const selectedAssignmentsDiv = document.getElementById('selected_' + type + 's');

        if (selectedId && !document.querySelector(`#selected_${type}s .assignment-tag[data-id="${selectedId}"]`)) {
            const tag = document.createElement('span');
            tag.className = 'assignment-tag';
            tag.setAttribute('data-id', selectedId);
            tag.innerHTML = `
                ${selectedName}
                <input type="hidden" name="assigned_${type}s" value="${selectedId}">
                <button type="button" class="remove-button" onclick="removeAssignment(this)">‚úñÔ∏è</button>
            `;
            selectedAssignmentsDiv.appendChild(tag);
        }
    }

    function removeAssignment(buttonElement) {
        const tag = buttonElement.closest('.assignment-tag');
        if (tag) {
            tag.remove();
        }
    }
</script>