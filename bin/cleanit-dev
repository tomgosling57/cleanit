#!/bin/bash
# CleanIt Development Environment Manager
# Main script that delegates to subcommands

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_ROOT"

DOCKER_COMPOSE_CMD="docker compose"
echo "üì¶ Using: $DOCKER_COMPOSE_CMD"

# Default command
CMD="${1:-help}"
shift

case "$CMD" in
    start|up)
        echo "üöÄ Starting CleanIt development environment..."
        
        # Check if --build flag is provided
        if [[ " $* " =~ " --build " ]]; then
            echo "üî® Building containers..."
            $DOCKER_COMPOSE_CMD -f docker-compose.yml up --build "$@"
        else
            echo "‚ö° Starting without rebuild (use --build to force rebuild)"
            $DOCKER_COMPOSE_CMD -f docker-compose.yml up "$@"
        fi
        ;;
    
    stop|down)
        echo "üõë Stopping CleanIt development environment..."
        $DOCKER_COMPOSE_CMD -f docker-compose.yml down "$@"
        ;;
    
    restart)
        echo "üîÑ Restarting CleanIt development environment..."
        $DOCKER_COMPOSE_CMD -f docker-compose.yml restart "$@"
        ;;
    
    logs)
        echo "üìã Showing logs..."
        $DOCKER_COMPOSE_CMD -f docker-compose.yml logs -f "$@"
        ;;
    
    shell)
        echo "üêö Opening Flask shell..."
        $DOCKER_COMPOSE_CMD -f docker-compose.yml -f docker-compose.dev.yml exec web flask shell
        ;;
    
    test)
        echo "üß™ Running tests..."
        $DOCKER_COMPOSE_CMD -f docker-compose.yml -f docker-compose.dev.yml exec web pytest "$@"
        ;;
    
    status|ps)
        echo "üìä Container status:"
        $DOCKER_COMPOSE_CMD -f docker-compose.yml ps
        ;;
    
    build)
        echo "üî® Rebuilding containers..."
        $DOCKER_COMPOSE_CMD -f docker-compose.yml build "$@"
        ;;
    
    fast|quick)
        echo "‚ö° Starting CleanIt development environment (fast mode - no rebuild)..."
        $DOCKER_COMPOSE_CMD -f docker-compose.yml up "$@"
        ;;
    
    clean)
        echo "üßπ Cleaning up (stopping and removing volumes)..."
        $DOCKER_COMPOSE_CMD -f docker-compose.yml down -v
        ;;
    
    help|--help|-h)
        echo "CleanIt Development Environment Manager"
        echo ""
        echo "Usage: cleanit-dev [COMMAND] [OPTIONS]"
        echo ""
        echo "Commands:"
        echo "  start, up     Start development environment (with build if needed)"
        echo "  fast, quick   Start without rebuilding containers"
        echo "  stop, down    Stop development environment"
        echo "  restart       Restart containers"
        echo "  logs          View logs (follow with -f)"
        echo "  shell         Open Flask shell in container"
        echo "  test          Run tests (pass pytest args)"
        echo "  status, ps    Show container status"
        echo "  build         Rebuild containers"
        echo "  clean         Stop and remove volumes"
        echo "  help          Show this help"
        echo ""
        echo "Examples:"
        echo "  cleanit-dev start          # Start all services"
        echo "  cleanit-dev start -d       # Start in detached mode"
        echo "  cleanit-dev stop           # Stop services"
        echo "  cleanit-dev logs -f web    # Follow web logs"
        echo "  cleanit-dev test -v        # Run tests verbosely"
        echo "  cleanit-dev shell          # Open Flask shell"
        ;;
    
    *)
        echo "‚ùå Unknown command: $CMD"
        echo "Use 'cleanit-dev help' for usage information."
        exit 1
        ;;
esac