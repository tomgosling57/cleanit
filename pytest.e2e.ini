[tool:pytest]
# Docker testing configuration
# This config is for e2e tests to be executed on the docker configuration using PostgreSQL and S3/MinIO in the docker network

# Test discovery - only run Docker tests
testpaths = tests/2
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Addopts for Docker tests
addopts = 
    --tb=short
    --strict-markers
    -v
    --disable-warnings
    --docker  # Custom marker to identify Docker tests

# Markers
markers =
    docker: tests that require Docker (required for all Docker tests)
    slow: marks tests as slow
    integration: integration tests that require external services
    no_csrf: tests that require CSRF protection disabled
    playwright: tests that use Playwright browser automation

# Configuration for Docker environment
env =
    FLASK_ENV = testing
    STORAGE_PROVIDER = s3
    DATABASE_URL = postgresql://cleanit_user@localhost:5432/cleanit
    SECRET_KEY = test-secret-key-for-docker-tests
    S3_BUCKET = cleanit-media
    AWS_REGION = us-east-1
    AWS_ACCESS_KEY_ID = minioadmin
    AWS_SECRET_ACCESS_KEY = minioadmin
    S3_ENDPOINT_URL = http://localhost:9000
    S3_USE_HTTPS = false
    S3_VERIFY_SSL = false
    S3_PUBLIC_HOST = localhost
    S3_PUBLIC_PORT = 9000

# Require e2e marker for all tests
# This ensures tests won't run accidentally without Docker
required_markers = e2e

# Test execution
xfail_strict = true
filterwarnings =
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning

# Skip if Docker containers not running
# This will be handled by the conftest.py in tests/e2e/
# but we add a safety check here too
def pytest_collection_modifyitems(config, items):
    """Skip all tests if Docker containers are not running."""
    import subprocess
    import os
    
    def docker_containers_running():
        try:
            result = subprocess.run(
                ['docker', 'compose', 'ps', '--services', '--filter', 'status=running'],
                capture_output=True,
                text=True,
                cwd=os.path.dirname(os.path.dirname(__file__))
            )
            running_services = result.stdout.strip().split('\n')
            required_services = {'postgres', 'minio', 'web'}
            return all(service in running_services for service in required_services)
        except (subprocess.SubprocessError, FileNotFoundError):
            return False
    
    if not docker_containers_running():
        skip_marker = pytest.mark.skip(reason="Docker containers not running")
        for item in items:
            item.add_marker(skip_marker)